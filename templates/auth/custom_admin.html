{% extends "base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto bg-white p-6 rounded shadow">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">Admin Dashboard</h1>
        <a href="{% url 'dashboard' %}" class="text-blue-600 hover:underline text-sm font-medium">
            ← Back to Dashboard
        </a>
    </div>

    <!-- Display messages -->
    {% if messages %}
        <div class="mb-6 space-y-2">
            {% for message in messages %}
                <div class="p-4 rounded {% if message.tags == 'error' %}bg-red-100 text-red-700{% elif message.tags == 'warning' %}bg-yellow-100 text-yellow-700{% elif message.tags == 'success' %}bg-green-100 text-green-700{% else %}bg-blue-100 text-blue-700{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- File Upload Settings -->
    <div class="mb-8 pb-6 border-b border-gray-200">
        <h2 class="text-xl font-semibold mb-4">File Upload Settings</h2>
        <form method="POST" class="flex items-center gap-3">
            {% csrf_token %}
            <label class="font-medium text-gray-700">Max File Size (MB):</label>
            <input type="number" 
                   name="max_file_size" 
                   value="{{ max_file_size_mb }}" 
                   min="1"
                   class="border border-gray-300 p-2 rounded w-24 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <button type="submit" 
                    class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition font-medium">
                Save Settings
            </button>
        </form>
        <p class="text-gray-500 text-sm mt-3">
            Current maximum file size: <span class="font-semibold text-gray-700">{{ max_file_size_mb }} MB</span>
        </p>
    </div>

    <!-- User Management -->
    <div>
        <h2 class="text-xl font-semibold mb-4">User Management</h2>
        <div class="overflow-x-auto">
            <table class="w-full border-collapse border border-gray-300">
                <thead>
                    <tr class="bg-gray-100">
                        <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Username</th>
                        <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Email</th>
                        <th class="border border-gray-300 px-4 py-3 text-center font-semibold text-gray-700">Status</th>
                        <th class="border border-gray-300 px-4 py-3 text-center font-semibold text-gray-700">Role</th>
                        <th class="border border-gray-300 px-4 py-3 text-center font-semibold text-gray-700">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr class="{% if not user.is_active %}bg-gray-50{% else %}hover:bg-gray-50{% endif %} transition">
                        <td class="border border-gray-300 px-4 py-3">
                            <div class="flex items-center gap-2">
                                <span class="font-medium">{{ user.username }}</span>
                                {% if user == request.user %}
                                    <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-medium">You</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="border border-gray-300 px-4 py-3 text-gray-600">
                            {{ user.email|default:"No email" }}
                        </td>
                        <td class="border border-gray-300 px-4 py-3 text-center">
                            {% if user.is_active %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                                    ✓ Active
                                </span>
                            {% else %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800">
                                    ✗ Inactive
                                </span>
                            {% endif %}
                        </td>
                        <td class="border border-gray-300 px-4 py-3 text-center">
                            {% if user.is_superuser %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-purple-100 text-purple-800">
                                    Admin
                                </span>
                            {% else %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-600">
                                    User
                                </span>
                            {% endif %}
                        </td>
                        <td class="border border-gray-300 px-4 py-3 text-center">
                            {% if user == request.user %}
                                <span class="text-gray-400 text-sm">Cannot modify self</span>
                            {% else %}
                                <div class="flex gap-2 justify-center flex-wrap">
                                    <!-- Activate/Deactivate Button -->
                                    <button onclick="confirmToggleStatus('{{ user.username }}', {{ user.is_active|lower }}, {{ user.id }})" 
                                            class="{% if user.is_active %}bg-yellow-500 hover:bg-yellow-600{% else %}bg-green-600 hover:bg-green-700{% endif %} text-white px-3 py-1 rounded transition text-sm font-medium">
                                        {% if user.is_active %}Deactivate{% else %}Activate{% endif %}
                                    </button>
                                    
                                    <!-- Delete Button -->
                                    <button onclick="confirmDeleteUser('{{ user.username }}', {{ user.id }})" 
                                            class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded transition text-sm font-medium">
                                        Delete
                                    </button>
                                </div>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% if not users %}
            <div class="text-center py-8 bg-gray-50 rounded-lg mt-4">
                <p class="text-gray-500">No users found.</p>
            </div>
        {% endif %}
    </div>
</div>

<script>
function confirmToggleStatus(username, isActive, userId) {
    const action = isActive ? 'deactivate' : 'activate';
    const message = isActive 
        ? `Are you sure you want to DEACTIVATE user "${username}"?\n\nThis will:\n• Prevent them from logging in\n• Keep all their files\n• Can be reversed later`
        : `Are you sure you want to ACTIVATE user "${username}"?\n\nThis will:\n• Allow them to login\n• Restore their access`;
    
    if (confirm(message)) {
        window.location.href = `/toggle-user/${userId}/`;
    }
}

function confirmDeleteUser(username, userId) {
    const message = `⚠️ WARNING: PERMANENT DELETION ⚠️\n\nAre you ABSOLUTELY SURE you want to DELETE user "${username}"?\n\nThis action will:\n• PERMANENTLY delete the user account\n• DELETE ALL files uploaded by this user\n• CANNOT be undone\n• Free up storage space\n\nType the username "${username}" below to confirm:`;
    
    const confirmation = prompt(message);
    
    if (confirmation === username) {
        // Create a form and submit it
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/delete-user/${userId}/`;
        
        // Add CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        
        document.body.appendChild(form);
        form.submit();
    } else if (confirmation !== null) {
        alert('Username did not match. Deletion cancelled.');
    }
}
</script>

{% endblock %}